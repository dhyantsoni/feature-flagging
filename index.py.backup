"""
Vercel entry point - Flask WSGI application
"""
import sys
import os
from pathlib import Path
from flask import Flask, jsonify

# Setup Flask app
app = Flask(__name__)

# Add basic routes
@app.route('/')
def home():
    return jsonify({"message": "Feature Flagging API", "status": "ok"})

@app.route('/health')
def health():
    return jsonify({"status": "healthy", "checks": {"supabase": False, "feature_flags": False}})

@app.route('/debug')
def debug():
    api_index = Path(__file__).parent / 'api' / 'index.py'
    return jsonify({
        "app_loaded": type(app).__name__,
        "num_routes": len(app.url_map._rules),
        "file": __file__,
        "parent": str(Path(__file__).parent),
        "api_index_exists": api_index.exists(),
        "api_index_path": str(api_index),
        "load_error": load_error if 'load_error' in globals() else None
    })

@app.route('/api')
def api_info():
    return jsonify({
        "message": "Feature Flagging API",
        "version": "1.0",
        "endpoints": {
            "health": "/health",
            "clients": "/api/clients",
            "rulesets": "/api/rulesets"
        }
    })

# Try to load the full app from api/index.py
load_error = None
try:
    api_dir = Path(__file__).parent / 'api'
    api_index_path = api_dir / "index.py"
    
    if not api_index_path.exists():
        raise FileNotFoundError(f"api/index.py not found at {api_index_path}")
    
    # Import with explicit module name to avoid collision
    import importlib.util
    spec = importlib.util.spec_from_file_location("api_app", str(api_index_path))
    if spec is None or spec.loader is None:
        raise RuntimeError("Could not create module spec for api/index.py")
    
    api_module = importlib.util.module_from_spec(spec)
    spec.loader.exec_module(api_module)
    
    # Replace the app with the full API app
    if hasattr(api_module, 'app'):
        app = api_module.app
    else:
        raise AttributeError("api_module does not have 'app' attribute")
        
except Exception as e:
    import traceback
    load_error = str(e)
    error_traceback = traceback.format_exc()
    print(f"Warning: Could not load full API app: {e}")
    print(error_traceback)
    # Continue with minimal app

# Export for Vercel
application = app
